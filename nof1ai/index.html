<!DOCTYPE html>
<html lang="en"> <!-- Language set to English -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Bot Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #f3f4f6;
        }
        .card {
            background-color: #1f2937; /* Card background */
            border: 1px solid #374151; /* Card border */
            border-radius: 0.5rem; /* 8px */
        }
        .text-main { color: #f9fafb; }
        .text-secondary { color: #9ca3af; }
        .text-positive { color: #22c55e; }
        .text-negative { color: #ef4444; }
        .border-divider { border-color: #374151; }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem; /* 12px */
            line-height: 1rem; /* 16px */
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .btn-danger:hover { opacity: 1; }
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        .status-live { background-color: #22c55e; }
        .status-down { background-color: #ef4444; animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* Style for code blocks */
        pre {
            background-color: #374151;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.75rem;
            color: #e5e7eb;
        }
        /* Accordion style */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-content.expanded { max-height: 600px; /* Increased max-height */ }
        .accordion-button { cursor: pointer; user-select: none;}
        .rotate-180 { transform: rotate(180deg); }
        /* Sticky table header */
        thead th { position: sticky; top: 0; background-color: #1f2937; z-index: 10;}
        /* Ellipsis for long invalidation text */
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* Adjust width as needed */
            display: inline-block; /* Needed for max-width */
            vertical-align: middle; /* Align nicely */
            cursor: help; /* Indicate it's hoverable/clickable */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-7xl space-y-6">

        <!-- Header -->
        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-main">DeepSeek Bot Admin Panel</h1>
            <div id="statusIndicator" class="flex items-center space-x-2">
                <span class="status-dot status-down"></span>
                <span class="text-sm font-medium text-secondary">DISCONNECTED</span>
            </div>
        </div>

        <!-- Key Stats -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
             <div class="card p-4">
                <h2 class="text-xs sm:text-sm font-medium text-secondary uppercase">Total Value</h2>
                <p id="totalValue" class="text-xl sm:text-2xl font-bold text-main mt-1">$...</p>
            </div>
            <div class="card p-4">
                <h2 class="text-xs sm:text-sm font-medium text-secondary uppercase">Total PNL (%)</h2>
                <p id="totalReturn" class="text-xl sm:text-2xl font-bold mt-1">...</p>
            </div>
            <div class="card p-4">
                <h2 class="text-xs sm:text-sm font-medium text-secondary uppercase">Available Cash</h2>
                <p id="availableCash" class="text-xl sm:text-2xl font-bold text-main mt-1">$...</p>
            </div>
            <div class="card p-4">
                <h2 class="text-xs sm:text-sm font-medium text-secondary uppercase">Closed Trades</h2>
                <p id="tradeCount" class="text-xl sm:text-2xl font-bold text-main mt-1">...</p>
            </div>
            <div class="card p-4">
                <h2 class="text-xs sm:text-sm font-medium text-secondary uppercase">Win Rate</h2>
                <p id="winRate" class="text-xl sm:text-2xl font-bold text-main mt-1">...</p>
            </div>
            <div class="card p-4">
                <h2 class="text-xs sm:text-sm font-medium text-secondary uppercase">Risk Level</h2>
                <p id="riskLevel" class="text-xl sm:text-2xl font-bold text-main mt-1">...</p>
            </div>
            <div class="card p-4">
                <h2 class="text-xs sm:text-sm font-medium text-secondary uppercase">Sharpe Ratio</h2>
                <p id="sharpeRatio" class="text-xl sm:text-2xl font-bold text-main mt-1">...</p>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="card">
            <h2 class="text-lg font-bold text-main p-4 border-b border-divider">Recent Alerts</h2>
            <div id="alertsContainer" class="p-4 space-y-3 max-h-64 overflow-y-auto">
                <p class="text-secondary text-center p-4">Loading alerts...</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Column 1: Active Positions -->
            <div class="card lg:col-span-1">
                <h2 class="text-lg font-bold text-main p-4 border-b border-divider">Active Positions</h2>
                <div id="positionsGrid" class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- Positions loaded here -->
                    <p class="text-secondary text-center p-4">Loading positions...</p>
                </div>
            </div>

            <!-- Column 2: Trade History & AI Cycle History (Tabbed Interface) -->
            <div class="card lg:col-span-2">
                <div class="border-b border-divider">
                    <nav class="-mb-px flex space-x-4 sm:space-x-8 px-4 overflow-x-auto" aria-label="Tabs">
                        <button id="tab-ai-history" onclick="switchTab('ai-history')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-400" aria-current="page">
                            AI Cycle History
                        </button>
                        <button id="tab-trade-history" onclick="switchTab('trade-history')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">
                            Trade History
                        </button>
                    </nav>
                </div>

                <!-- AI Cycle History Content -->
                <div id="content-ai-history" class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                     <p class="text-secondary text-center p-4">Loading AI cycle history...</p>
                </div>

                <!-- Trade History Content (Hidden by default) -->
                <div id="content-trade-history" class="hidden overflow-x-auto max-h-[70vh]">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="sticky top-0 bg-[#1f2937]">
                             <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Coin</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Direction</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Amount (USD)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Entry/Exit Price</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">PnL</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Time</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Close Reason</th> <!-- NEW Column -->
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-800">
                            <!-- Trade history loaded here -->
                            <tr>
                                <td colspan="8" class="px-4 py-4 text-center text-secondary">Loading trade history...</td> <!-- Colspan updated -->
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div> <!-- End Main Content Grid -->

    </div> <!-- End Container -->

    <script>
        // --- Element References ---
        const statusIndicator = document.getElementById('statusIndicator');
        const statusDot = statusIndicator.querySelector('.status-dot');
        const statusText = statusIndicator.querySelector('span:last-child');
        const totalValueEl = document.getElementById('totalValue');
        const totalReturnEl = document.getElementById('totalReturn');
        const availableCashEl = document.getElementById('availableCash');
        const tradeCountEl = document.getElementById('tradeCount');
        const winRateEl = document.getElementById('winRate');
        const riskLevelEl = document.getElementById('riskLevel');
        const sharpeRatioEl = document.getElementById('sharpeRatio');
        const positionsGridEl = document.getElementById('positionsGrid');
        const historyTableBodyEl = document.getElementById('historyTableBody');
        const aiHistoryContentEl = document.getElementById('content-ai-history');
        const alertsContainerEl = document.getElementById('alertsContainer');

        // --- Tab Switching Logic ---
        const tabs = ['ai-history', 'trade-history'];
        function switchTab(activeTabId) {
            tabs.forEach(tabId => {
                const tabButton = document.getElementById(`tab-${tabId}`);
                const contentDiv = document.getElementById(`content-${tabId}`);
                if (!tabButton || !contentDiv) return;

                if (tabId === activeTabId) {
                    tabButton.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
                    tabButton.classList.add('border-indigo-500', 'text-indigo-400');
                    tabButton.setAttribute('aria-current', 'page');
                    contentDiv.classList.remove('hidden');
                } else {
                    tabButton.classList.remove('border-indigo-500', 'text-indigo-400');
                    tabButton.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
                    tabButton.removeAttribute('aria-current');
                    contentDiv.classList.add('hidden');
                }
            });
        }

        // --- Data Fetching ---
        let fetchInterval;
        const FETCH_INTERVAL_MS = 15000; // 15 seconds

        async function fetchData() {
            try {
                const stateResponse = await fetch('portfolio_state.json?t=' + Date.now());
                if (!stateResponse.ok) throw new Error('portfolio_state.json fetch failed.');
                const stateData = await stateResponse.json();
                if (typeof stateData !== 'object' || stateData === null) throw new Error('Invalid state data.');
                updateDashboard(stateData);

                const tradeHistoryResponse = await fetch('trade_history.json?t=' + Date.now());
                if (tradeHistoryResponse.ok) {
                    const tradeHistoryData = await tradeHistoryResponse.json();
                     if (!Array.isArray(tradeHistoryData)) throw new Error('Invalid trade history data.');
                    updateTradeHistory(tradeHistoryData);
                } else {
                     console.warn('Could not fetch trade_history.json');
                     updateTradeHistory([]);
                }

                const cycleHistoryResponse = await fetch('cycle_history.json?t=' + Date.now());
                if (cycleHistoryResponse.ok) {
                    const cycleHistoryData = await cycleHistoryResponse.json();
                    if (!Array.isArray(cycleHistoryData)) throw new Error('Invalid cycle history data.');
                    updateCycleHistory(cycleHistoryData);
                } else {
                     console.warn('Could not fetch cycle_history.json');
                     updateCycleHistory([]);
                }

                statusDot.classList.remove('status-down');
                statusDot.classList.add('status-live');
                const lastUpdatedTime = stateData.last_updated ? new Date(stateData.last_updated).toLocaleTimeString() : 'N/A';
                statusText.textContent = `LIVE (Updated: ${lastUpdatedTime})`;
                statusText.classList.remove('text-negative', 'text-secondary');
                statusText.classList.add('text-positive');

            } catch (error) {
                console.error("Fetch data error:", error.message);
                statusDot.classList.remove('status-live');
                statusDot.classList.add('status-down');
                statusText.textContent = 'DISCONNECTED';
                statusText.classList.remove('text-positive');
                statusText.classList.add('text-negative', 'text-secondary');
            }
        }

        // --- UI Update Functions ---

        function formatCurrency(value, defaultVal = 'N/A') {
            if (value === null || value === undefined || isNaN(value)) return defaultVal;
            try {
                return Number(value).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } catch { return defaultVal; }
        }

        function formatPercent(value, defaultVal = 'N/A') {
             if (value === null || value === undefined || isNaN(value)) return defaultVal;
             try { return Number(value).toFixed(2) + '%'; } catch { return defaultVal; }
        }

        function formatNumber(value, decimals = 4, defaultVal = 'N/A') {
             if (value === null || value === undefined || isNaN(value)) return defaultVal;
             const num = Number(value);
             if (isNaN(num)) return defaultVal;
             try { return num.toFixed(decimals); } catch { return defaultVal; }
        }

         function formatDateTime(isoString, type = 'time', defaultVal = 'N/A') {
            if (!isoString) return defaultVal;
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return defaultVal;
                if (type === 'date') {
                    return date.toLocaleDateString([], { month: '2-digit', day: '2-digit', year: 'numeric' });
                } else {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit'});
                }
            } catch (e) {
                console.error("Error formatting date:", isoString, e);
                return defaultVal;
            }
        }

        function escapeHtml(data) {
             if (typeof data === 'object') {
                 try { return JSON.stringify(data, null, 2).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
                 catch { return 'Invalid Data'; }
             }
             if (typeof data !== 'string') return String(data);
             return data.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function updateDashboard(data) {
            const defaultData = { total_value: null, current_balance: null, total_return: null, sharpe_ratio: null };
            const currentData = data || defaultData;
            totalValueEl.textContent = formatCurrency(currentData.total_value, '$...');
            availableCashEl.textContent = formatCurrency(currentData.current_balance, '$...');
            const totalReturn = currentData.total_return;
            totalReturnEl.textContent = (totalReturn !== null && totalReturn > 0 ? '+' : '') + formatPercent(totalReturn, '...');
            totalReturnEl.classList.toggle('text-positive', totalReturn !== null && totalReturn >= 0);
            totalReturnEl.classList.toggle('text-negative', totalReturn !== null && totalReturn < 0);
            
            // Update Sharpe ratio
            const sharpeRatio = currentData.sharpe_ratio;
            sharpeRatioEl.textContent = sharpeRatio !== null && !isNaN(sharpeRatio) ? formatNumber(sharpeRatio, 3) : '...';
            sharpeRatioEl.className = `text-xl sm:text-2xl font-bold mt-1 ${
                sharpeRatio !== null && sharpeRatio > 1 ? 'text-positive' : 
                sharpeRatio !== null && sharpeRatio > 0 ? 'text-yellow-500' : 'text-negative'
            }`;
            
            updateActivePositions(data ? data.positions || {} : {});
        }

        // --- UPDATED Active Positions Function ---
        function updateActivePositions(positions) {
            positionsGridEl.innerHTML = '';
            const coinKeys = Object.keys(positions);

            if (coinKeys.length === 0) {
                positionsGridEl.innerHTML = '<p class="text-secondary text-center p-4">No active positions.</p>';
                return;
            }

            coinKeys.forEach(coin => {
                const pos = positions[coin];
                if (!pos || typeof pos !== 'object') return;

                const pnl = pos.unrealized_pnl;
                const pnlClass = (pnl !== null && !isNaN(pnl) && pnl >= 0) ? 'text-positive' : 'text-negative';
                const direction = (pos.direction || 'long').toUpperCase();
                const directionClass = direction === 'LONG' ? 'text-positive' : 'text-negative';
                const exitPlan = pos.exit_plan || {};
                // NEW: Get invalidation condition
                const invalidationText = exitPlan.invalidation_condition || 'N/A';

                const card = `
                    <div class="card p-4 border-l-4 ${direction === 'LONG' ? 'border-green-500' : 'border-red-500'}">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-bold text-main">${pos.symbol || coin}</span>
                            <span class="font-semibold ${directionClass}">${direction} ${pos.leverage || 1}x</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xl font-bold ${pnlClass}">${formatCurrency(pnl)}</span>
                            <span class="text-sm text-secondary">Notional: ${formatCurrency(pos.notional_usd)}</span>
                        </div>
                        <div class="text-xs text-secondary space-y-1 mb-4">
                            <div class="flex justify-between"><span class="font-medium">Qty:</span><span>${formatNumber(pos.quantity, 6)}</span></div>
                            <div class="flex justify-between"><span class="font-medium">Entry:</span><span>${formatCurrency(pos.entry_price)}</span></div>
                            <div class="flex justify-between"><span class="font-medium">Liq (Est):</span><span>${formatCurrency(pos.liquidation_price)}</span></div>
                            <div class="flex justify-between"><span class="font-medium">Confidence:</span><span>${formatPercent((pos.confidence || 0) * 100)}</span></div>
                            <div class="flex justify-between"><span class="font-medium">TP:</span><span>${exitPlan.profit_target || 'N/A'}</span></div>
                            <div class="flex justify-between"><span class="font-medium">SL:</span><span>${exitPlan.stop_loss || 'N/A'}</span></div>
                            <!-- NEW: Invalidation Condition Display -->
                            <div class="flex justify-between items-center">
                                <span class="font-medium">Invalidation:</span>
                                <span class="truncate-text" title="${escapeHtml(invalidationText)}">${escapeHtml(invalidationText)}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <button class="btn-danger" onclick="forceClosePosition('${coin}')">
                                FORCE CLOSE
                            </button>
                        </div>
                    </div>
                `;
                positionsGridEl.innerHTML += card;
            });
        }

        // --- UPDATED Trade History Function ---
        function updateTradeHistory(history) {
             tradeCountEl.textContent = history ? history.length : 0;

            historyTableBodyEl.innerHTML = '';
            if (!history || history.length === 0) {
                historyTableBodyEl.innerHTML = '<tr><td colspan="8" class="px-4 py-4 text-center text-secondary">No closed trades yet.</td></tr>'; // Colspan is now 8
                return;
            }

            history.slice().reverse().forEach(trade => {
                 if (!trade || typeof trade !== 'object') return;
                const pnl = trade.pnl;
                const pnlClass = (pnl !== null && !isNaN(pnl) && pnl >= 0) ? 'text-positive' : 'text-negative';
                const direction = (trade.direction || 'long').toUpperCase();
                // NEW: Get close reason
                const closeReason = trade.close_reason || 'N/A';

                const row = `
                    <tr class="border-b border-divider hover:bg-gray-700/50">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="text-sm font-bold text-main">${trade.symbol || 'N/A'}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="text-sm font-semibold ${direction === 'LONG' ? 'text-positive' : 'text-negative'}">${direction} ${trade.leverage || ''}x</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="text-sm text-main">${formatCurrency(trade.notional_usd, 'N/A')}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs text-secondary">
                            <div>${formatNumber(trade.entry_price)}</div>
                            <div>→ ${formatNumber(trade.exit_price)}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="text-sm font-bold ${pnlClass}">${formatCurrency(pnl)}</span>
                        </td>
                         <td class="px-4 py-3 whitespace-nowrap text-xs text-secondary">
                            ${formatDateTime(trade.exit_time || trade.entry_time, 'date')}
                         </td>
                         <td class="px-4 py-3 whitespace-nowrap text-xs text-secondary">
                            ${formatDateTime(trade.exit_time || trade.entry_time, 'time')}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs text-secondary" title="${escapeHtml(closeReason)}">
                            <span class="truncate-text">${escapeHtml(closeReason)}</span> <!-- NEW: Close Reason -->
                        </td>
                    </tr>
                `;
                historyTableBodyEl.innerHTML += row;
            });
        }

        // --- Update AI Cycle History ---
        function updateCycleHistory(history) {
            aiHistoryContentEl.innerHTML = '';
            if (!history || history.length === 0) {
                aiHistoryContentEl.innerHTML = '<p class="text-secondary text-center p-4">No AI cycle history yet.</p>';
                return;
            }

            const expandedAccordions = new Set(
                Array.from(document.querySelectorAll('.accordion-content.expanded'))
                     .map(el => el.id.replace('content-', ''))
            );

            history.slice().reverse().forEach((cycle, index) => {
                if (!cycle || typeof cycle !== 'object') return;
                const accordionId = `cycle-${cycle.cycle || index}`;

                const cycleDiv = document.createElement('div');
                cycleDiv.className = 'card p-4 space-y-2';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex justify-between items-center accordion-button';
                headerDiv.onclick = () => toggleAccordion(accordionId);
                headerDiv.innerHTML = `
                    <h3 class="text-md font-semibold text-main">Cycle ${cycle.cycle || 'N/A'} - ${formatDateTime(cycle.timestamp, 'time')}</h3>
                    <svg id="arrow-${accordionId}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-secondary transform transition-transform ${expandedAccordions.has(accordionId) ? 'rotate-180' : ''}">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                    </svg>
                `;
                cycleDiv.appendChild(headerDiv);

                const contentDiv = document.createElement('div');
                contentDiv.id = `content-${accordionId}`;
                const isExpanded = expandedAccordions.has(accordionId);
                contentDiv.className = `accordion-content space-y-3 pt-2 border-t border-divider mt-2 ${isExpanded ? 'expanded' : ''}`;


                contentDiv.innerHTML += `
                    <div>
                        <h4 class="text-xs font-medium text-secondary uppercase mb-1">Chain of Thoughts:</h4>
                        <pre class="max-h-48 overflow-y-auto">${escapeHtml(cycle.chain_of_thoughts || 'N/A')}</pre>
                    </div>
                `;
                contentDiv.innerHTML += `
                    <div>
                        <h4 class="text-xs font-medium text-secondary uppercase mb-1">Decisions:</h4>
                        <pre>${escapeHtml(cycle.decisions || {})}</pre>
                    </div>
                `;
                 contentDiv.innerHTML += `
                    <div>
                        <h4 class="text-xs font-medium text-secondary uppercase mb-1">User Prompt (Summary):</h4>
                        <pre class="max-h-24 overflow-y-auto">${escapeHtml(cycle.user_prompt_summary || 'N/A')}</pre>
                    </div>
                `;

                cycleDiv.appendChild(contentDiv);
                aiHistoryContentEl.appendChild(cycleDiv);
            });
        }

        function toggleAccordion(accordionId) {
            const content = document.getElementById(`content-${accordionId}`);
            const arrow = document.getElementById(`arrow-${accordionId}`);
            if (content && arrow) {
                // Check state *before* toggling
                const isOpening = !content.classList.contains('expanded');

                // Optional: Close others only when opening a new one
                if (isOpening) {
                    document.querySelectorAll('.accordion-content.expanded').forEach(el => {
                        if(el.id !== `content-${accordionId}`) {
                            el.classList.remove('expanded');
                            const otherArrowId = el.id.replace('content-', 'arrow-');
                            document.getElementById(otherArrowId)?.classList.remove('rotate-180');
                        }
                    });
                }

                // Toggle the clicked one
                content.classList.toggle('expanded');
                arrow.classList.toggle('rotate-180');
            }
        }

        // --- Manual Override Function ---
        async function forceClosePosition(coin) {
            if (!confirm(`Are you sure you want to manually force close the ${coin} position? This will override the AI's plan.`)) {
                return;
            }
            try {
                const response = await fetch('/force-close', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ coin: coin }),
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    alert(`Close command sent successfully for ${coin}. The bot will close the position in the next cycle (max 2 mins).`);
                } else {
                    throw new Error(result.message || 'Unknown error.');
                }
            } catch (error) {
                alert(`Error: Could not send close command. Is the admin server running?\n\nDetails: ${error.message}`);
            }
        }

        // --- Update Alerts ---
        function updateAlerts(alerts) {
            alertsContainerEl.innerHTML = '';
            
            if (!alerts || alerts.length === 0) {
                alertsContainerEl.innerHTML = '<p class="text-secondary text-center p-4">No recent alerts.</p>';
                return;
            }

            alerts.slice().reverse().forEach(alert => {
                if (!alert || typeof alert !== 'object') return;
                
                const levelColors = {
                    'INFO': 'border-blue-500 bg-blue-500/10',
                    'WARNING': 'border-yellow-500 bg-yellow-500/10', 
                    'CRITICAL': 'border-red-500 bg-red-500/10'
                };
                
                const levelTextColors = {
                    'INFO': 'text-blue-400',
                    'WARNING': 'text-yellow-400',
                    'CRITICAL': 'text-red-400'
                };

                const level = alert.level || 'INFO';
                const borderColor = levelColors[level] || levelColors['INFO'];
                const textColor = levelTextColors[level] || levelTextColors['INFO'];
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `card p-3 border-l-4 ${borderColor}`;
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-sm font-semibold ${textColor}">${alert.title || 'Alert'}</span>
                        <span class="text-xs text-secondary">${formatDateTime(alert.timestamp, 'time')}</span>
                    </div>
                    <p class="text-sm text-main">${escapeHtml(alert.message || 'No message')}</p>
                    ${alert.symbol ? `<span class="text-xs text-secondary mt-1">Symbol: ${alert.symbol}</span>` : ''}
                `;
                
                alertsContainerEl.appendChild(alertDiv);
            });
        }

        // --- Calculate Performance Metrics ---
        function calculatePerformanceMetrics(tradeHistory) {
            if (!tradeHistory || tradeHistory.length === 0) {
                return { winRate: 0, riskLevel: 'Low' };
            }

            const winningTrades = tradeHistory.filter(trade => trade.pnl > 0);
            const winRate = (winningTrades.length / tradeHistory.length) * 100;
            
            // Simple risk level calculation based on recent volatility
            const recentTrades = tradeHistory.slice(-10);
            const pnlVolatility = recentTrades.length > 1 ? 
                Math.sqrt(recentTrades.reduce((sum, trade) => sum + Math.pow(trade.pnl, 2), 0) / recentTrades.length) : 0;
            
            let riskLevel = 'Low';
            if (pnlVolatility > 50) riskLevel = 'High';
            else if (pnlVolatility > 20) riskLevel = 'Medium';
            
            return { winRate, riskLevel };
        }

        // --- Enhanced Data Fetching ---
        async function fetchData() {
            try {
                const stateResponse = await fetch('portfolio_state.json?t=' + Date.now());
                if (!stateResponse.ok) throw new Error('portfolio_state.json fetch failed.');
                const stateData = await stateResponse.json();
                if (typeof stateData !== 'object' || stateData === null) throw new Error('Invalid state data.');
                updateDashboard(stateData);

                const tradeHistoryResponse = await fetch('trade_history.json?t=' + Date.now());
                let tradeHistoryData = [];
                if (tradeHistoryResponse.ok) {
                    tradeHistoryData = await tradeHistoryResponse.json();
                    if (!Array.isArray(tradeHistoryData)) throw new Error('Invalid trade history data.');
                    updateTradeHistory(tradeHistoryData);
                } else {
                    console.warn('Could not fetch trade_history.json');
                    updateTradeHistory([]);
                }

                const cycleHistoryResponse = await fetch('cycle_history.json?t=' + Date.now());
                if (cycleHistoryResponse.ok) {
                    const cycleHistoryData = await cycleHistoryResponse.json();
                    if (!Array.isArray(cycleHistoryData)) throw new Error('Invalid cycle history data.');
                    updateCycleHistory(cycleHistoryData);
                } else {
                    console.warn('Could not fetch cycle_history.json');
                    updateCycleHistory([]);
                }

                // Fetch alerts
                try {
                    const alertsResponse = await fetch('alerts.json?t=' + Date.now());
                    if (alertsResponse.ok) {
                        const alertsData = await alertsResponse.json();
                        if (Array.isArray(alertsData)) {
                            updateAlerts(alertsData);
                        }
                    }
                } catch (alertError) {
                    console.warn('Could not fetch alerts.json:', alertError.message);
                }

                // Update performance metrics
                const metrics = calculatePerformanceMetrics(tradeHistoryData);
                winRateEl.textContent = formatPercent(metrics.winRate, '0%');
                riskLevelEl.textContent = metrics.riskLevel;
                riskLevelEl.className = `text-xl sm:text-2xl font-bold mt-1 ${
                    metrics.riskLevel === 'High' ? 'text-negative' : 
                    metrics.riskLevel === 'Medium' ? 'text-yellow-500' : 'text-positive'
                }`;

                statusDot.classList.remove('status-down');
                statusDot.classList.add('status-live');
                const lastUpdatedTime = stateData.last_updated ? new Date(stateData.last_updated).toLocaleTimeString() : 'N/A';
                statusText.textContent = `LIVE (Updated: ${lastUpdatedTime})`;
                statusText.classList.remove('text-negative', 'text-secondary');
                statusText.classList.add('text-positive');

            } catch (error) {
                console.error("Fetch data error:", error.message);
                statusDot.classList.remove('status-live');
                statusDot.classList.add('status-down');
                statusText.textContent = 'DISCONNECTED';
                statusText.classList.remove('text-positive');
                statusText.classList.add('text-negative', 'text-secondary');
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            if (fetchInterval) clearInterval(fetchInterval);
            fetchInterval = setInterval(fetchData, FETCH_INTERVAL_MS);
        });

    </script>
</body>
</html>
